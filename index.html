<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VisionBank | CEG Contact Center Realtime Dashboard</title>

    <!-- Favicon Fix -->
    <link rel="icon" type="image/png" href="assets/VisionBank-Logo.png" />

    <link rel="stylesheet" href="style.css" />

    <!-- ======================================= -->
    <!-- VISIONBANK SECURITY PRE-CHECK INTEGRATION -->
    <!-- ======================================= -->
  <script>
  window.addEventListener("DOMContentLoaded", () => {
    (async function () {
      const overlay = document.getElementById("access-denied-overlay");
      const msgEl = document.getElementById("access-denied-message");
      const statusEl = document.getElementById("securityStatus");

      function showOverlay(text) {
        if (msgEl && text) {
          msgEl.textContent = text;
        }
        if (overlay) {
          overlay.classList.remove("hidden");
        }
        document.body.classList.remove("security-approved");
      }

      try {
        const res = await fetch(
          "https://visionbank-security.ahmedadeyemi.workers.dev/security/check",
          {
            method: "GET",
            mode: "cors",
            credentials: "omit"
          }
        );

        if (!res.ok) {
          showOverlay(
            "Unable to contact security service (HTTP " + res.status + ")."
          );
          return;
        }

        const data = await res.json();
        // Make result visible to dashboard.js if needed
        window.VB_SECURITY = data;

        // Access denied cases
        if (!data.allowed) {
          let text =
            "Your access is currently unavailable. Please contact the VisionBank IT Team.";

          if (data.reason === "ip-denied") {
            text =
              "Your access is being denied due to lack of permission. " +
              "Please contact the VisionBank IT Team to enable your access.";
          } else if (data.reason === "hours-closed") {
            text =
              "Your access is currently unavailable because this dashboard " +
              "is restricted to normal business hours.";
          }

          showOverlay(text);
          return;
        }

        // ✔ Access approved
        if (overlay) {
          overlay.classList.add("hidden");
        }
        document.body.classList.add("security-approved");

        if (statusEl && data.info) {
          statusEl.textContent =
            "Access approved from IP " +
            data.info.clientIp +
            " at " +
            data.info.nowCst.label +
            " (CST)";
        }
      } catch (err) {
        console.error("Security check failed:", err);
        showOverlay("Unable to contact security service.");
      }
    })();
  });
</script>
</head>

<body>

<!-- ACCESS DENIED OVERLAY (starts visible until Cloudflare approves) -->
<div id="access-denied-overlay" class="access-denied-overlay">
    <div class="access-denied-card">
        <h1>Access Restricted</h1>
        <p id="access-denied-message">
            Your access is currently unavailable. Please contact the IT Team for assistance.
        </p>
        <p class="access-denied-note">
            If you believe this is in error, contact the VisionBank IT Team.
        </p>
    </div>
</div>

<!-- HEADER -->
<header class="header">
    <div class="header-left">
        <!-- VisionBank logo in top-left -->
        <img src="assets/VisionBank-Logo.png" alt="VisionBank" class="logo" />
    </div>
    <div class="header-center">
        <h1>CEG Contact Center Realtime Dashboard</h1>
        <div class="header-subtitle">VisionBank</div>
    </div>
</header>

<main class="main">

    <!-- CURRENT QUEUE STATUS (TOP) -->
    <section class="panel">
        <h2>Current Queue Status</h2>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Queue</th>
                    <th>Calls</th>
                    <th>Agents</th>
                    <th>Max Wait</th>
                    <th>Avg Wait</th>
                </tr>
            </thead>
            <tbody id="queue-body">
                <tr>
                    <td colspan="5" class="loading">Loading queue status…</td>
                </tr>
            </tbody>
        </table>
    </section>

    <!-- AGENT PERFORMANCE (MIDDLE) -->
    <section class="panel">
        <h2>Agent Performance</h2>
        <table class="data-table">
            <thead>
                <tr>
                    <th>CEG Agent</th>
                    <th>Team</th>
                    <th>Phone No.</th>
                    <th>Availability</th>
                    <th>Inbound</th>
                    <th>Missed</th>
                    <th>Transferred</th>
                    <th>Outbound</th>
                    <th>Avg Handle</th>
                    <th>Duration</th>
                    <th>Start Date</th>
                </tr>
            </thead>
            <tbody id="agent-body">
                <tr>
                    <td colspan="11" class="loading">Loading agent data…</td>
                </tr>
            </tbody>
        </table>
    </section>

    <!-- REALTIME GLOBAL STATISTICS (BOTTOM) -->
    <section class="panel">
        <h2>Realtime Global Statistics</h2>
        <div id="global-error" class="error"></div>

        <div class="stat-grid">

            <div class="stat-card">
                <div class="stat-value" id="gs-total-queued">--</div>
                <div class="stat-label">Total Calls Queued</div>
            </div>

            <div class="stat-card">
                <div class="stat-value" id="gs-total-transferred">--</div>
                <div class="stat-label">Total Calls Transferred</div>
            </div>

            <div class="stat-card">
                <div class="stat-value" id="gs-total-abandoned">--</div>
                <div class="stat-label">Total Calls Abandoned</div>
            </div>

            <div class="stat-card">
                <div class="stat-value" id="gs-max-wait">--</div>
                <div class="stat-label">Maximum Queue Wait Time</div>
            </div>

            <div class="stat-card">
                <div class="stat-value" id="gs-service-level">--%</div>
                <div class="stat-label">Service Level</div>
            </div>

            <div class="stat-card">
                <div class="stat-value" id="gs-total-received">--</div>
                <div class="stat-label">Total Calls Received</div>
            </div>

            <div class="stat-card">
                <div class="stat-value" id="gs-answer-rate">--%</div>
                <div class="stat-label">Answer Rate</div>
            </div>

            <div class="stat-card">
                <div class="stat-value" id="gs-abandon-rate">--%</div>
                <div class="stat-label">Abandon Rate</div>
            </div>

            <div class="stat-card">
                <div class="stat-value" id="gs-callbacks-registered">--</div>
                <div class="stat-label">Callbacks Registered</div>
            </div>

            <div class="stat-card">
                <div class="stat-value" id="gs-callbacks-waiting">--</div>
                <div class="stat-label">Callbacks Waiting</div>
            </div>

        </div>
    </section>

</main>
<footer class="footer">
  <div class="footer-left">
    <img src="assets/VisionBank-Logo.png" alt="VisionBank" class="footer-logo" />
  </div>

  <div class="footer-center">
    <span id="securityStatus" class="security-status">
      Running security checks…
    </span>
  </div>

  <div class="footer-right">
    <span>Last updated: <span id="lastUpdated">--</span></span>
  </div>
</footer>
<script src="dashboard.js"></script>
</body>
</html>
