<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CEG Security Admin Console | VisionBank</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="security.css" />

  <!-- QR code + TOTP libraries (for Google Authenticator) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"
          integrity="sha512-4CjB0V0JxX7b5u5XvYpR0oGNP6calKZYErFQx0f8iKJ3Ejj6inUeJ8V+RaH//4W2KIiMzH6I0Xq1hKf7g8W8Kg=="
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/otplib/12.0.1/otplib.umd.min.js"
          integrity="sha512-vx17+ujCPqtykA1EuhaTt1S1S1pt6VqMy7RBCHp5oSe4nn1zOH1T/5K3Eo7FhWYeotkuX1KSb+I1N5kN1oJQBw=="
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script defer src="security.js"></script>
  <script defer src="security-dashboard.js"></script>

  <!-- ================================================================= -->
  <!-- ðŸš¨ INSERTED: VisionBank Security Enforcement Pre-Check Script     -->
  <!-- ================================================================= -->
  <script>
    (async function () {
      const workerBase = "https://visionbank-security.ahmedadeyemi.workers.dev";

      try {
        const res = await fetch(workerBase + "/security/check", {
          method: "GET",
          mode: "cors",
          credentials: "omit"
        });

        if (!res.ok) throw new Error("Worker error " + res.status);
        const data = await res.json();

        if (!data.allowed) {
          let message =
            "Your access is currently unavailable. Please contact the IT team.";

          if (data.reason === "ip-denied") {
            message =
              "Your access is being denied due to lack of permission. " +
              "Please contact the IT Team to enable your access.";
          } else if (data.reason === "hours-closed") {
            message =
              "Your access is currently unavailable due to being outside of " +
              "our normal business hours.";
          }

          document.body.innerHTML = `
            <div class="vb-denied-shell">
              <div class="vb-denied-card">
                <h1>Access Restricted</h1>
                <p>${message}</p>
                <p class="vb-denied-meta">
                  If you believe this is in error, please open a ticket with IT.
                </p>
              </div>
            </div>
          `;
          document.documentElement.classList.add("vb-locked");
        } else {
          window.VB_SECURITY = {
            allowed: true,
            info: data
          };
        }
      } catch (e) {
        console.error("Security check failed, falling back to local allow:", e);
        window.VB_SECURITY = { allowed: true, fallback: true };
      }
    })();
  </script>
  <!-- ================================================================= -->
</head>

<body>
  <!-- HEADER -->
  <header class="vb-header">
    <div class="vb-header-inner">
      <img src="assets/VisionBank-Logo.png"
           alt="VisionBank"
           class="vb-logo" />
      <div class="vb-header-text">
        <div class="vb-app">CEG Security Admin Console</div>
        <div class="vb-subapp">VisionBank</div>
      </div>
      <div class="vb-session" id="sessionIndicator">
        <!-- filled by JS -->
      </div>
    </div>
  </header>

  <main class="vb-main">
    <!-- ================= LOGIN STEP ================= -->
    <section id="loginView" class="card card-auth">
      <h1 class="card-title">Secure Administrator Login</h1>

      <form id="loginForm" class="form-vertical">
        <label class="field">
          <span>Admin Username</span>
          <input id="loginUsername" autocomplete="username" />
        </label>

        <label class="field">
          <span>PIN</span>
          <input id="loginPin" type="password" autocomplete="current-password" />
        </label>

        <button type="submit" class="btn btn-primary">Login</button>

        <p id="loginError" class="error-text"></p>
      </form>

      <button id="useOverrideBtn" class="link-button">Use Override Key</button>
    </section>

    <!-- ============= MFA SETUP STEP (first login) ============= -->
    <section id="mfaSetupView" class="card card-auth hidden">
      <h1 class="card-title">Google Authenticator Setup</h1>
      <p class="card-intro">
        Scan this QR code or use the text key below in your Google Authenticator app.
        After enrolling, enter a 6-digit code from the app to confirm.
      </p>

      <div class="mfa-layout">
        <div class="mfa-qr-wrapper">
          <div id="mfaQr" class="mfa-qr-placeholder">
          </div>
          <div class="mfa-qr-caption">Scan in Google Authenticator</div>
        </div>

        <form id="mfaSetupForm" class="mfa-form">
          <label class="field">
            <span>Account</span>
            <input id="mfaAccount" readonly />
          </label>

          <label class="field">
            <span>Secret Key</span>
            <input id="mfaSecret" readonly />
          </label>

          <label class="field">
            <span>Enter 6-digit code from app</span>
            <input id="mfaSetupCode" inputmode="numeric" maxlength="6" />
          </label>

          <button type="submit" class="btn btn-primary">
            Confirm & Enable MFA
          </button>

          <p id="mfaSetupError" class="error-text"></p>
        </form>
      </div>
    </section>

    <!-- ============= MFA VERIFY STEP (subsequent logins) ============= -->
    <section id="mfaVerifyView" class="card card-auth hidden">
      <h1 class="card-title">Multi-Factor Authentication</h1>
      <p class="card-intro">
        Enter the 6-digit code from your Google Authenticator app to continue.
      </p>

      <form id="mfaVerifyForm" class="form-vertical">
        <label class="field">
          <span>Security Code</span>
          <input id="mfaVerifyCode" inputmode="numeric" maxlength="6" />
        </label>

        <button type="submit" class="btn btn-primary">Verify Code</button>

        <p id="mfaVerifyError" class="error-text"></p>
      </form>

      <button id="mfaBackToLogin" class="link-button">Back to Login</button>
    </section>

    <!-- ================= ADMIN CONSOLE ================= -->
    <section id="adminConsole" class="card card-console hidden">
      <div class="console-header">
        <h1>VisionBank Security Administration</h1>
        <p>Access Control â€¢ Monitoring â€¢ Business Hours</p>
      </div>

      <div class="console-grid">
        <!-- IP ALLOWLIST -->
        <section class="console-section">
          <h2>IP Allowlist</h2>
          <p class="section-help">
            One entry per line. Supports single IPs (e.g. <code>45.19.161.17</code>)
            and CIDR ranges (e.g. <code>10.100.100.0/24</code>).
          </p>
          <textarea id="ipAllowlist" rows="10"
                    spellcheck="false"
                    class="mono"></textarea>
          <button id="saveIpRules" class="btn btn-secondary">
            Save IP Rules
          </button>
          <p id="ipSaveStatus" class="status-text"></p>
        </section>

        <!-- BUSINESS HOURS -->
        <section class="console-section">
          <h2>Business Hours</h2>
          <p class="section-help">
            Times are interpreted in Central Time (CST/CDT).
          </p>

          <div class="grid-2">
            <label class="field">
              <span>Start</span>
              <input id="bizStart" type="time" />
            </label>
            <label class="field">
              <span>End</span>
              <input id="bizEnd" type="time" />
            </label>
          </div>

          <div class="days-row">
            <label><input type="checkbox" class="biz-day" value="1" /> Mon</label>
            <label><input type="checkbox" class="biz-day" value="2" /> Tue</label>
            <label><input type="checkbox" class="biz-day" value="3" /> Wed</label>
            <label><input type="checkbox" class="biz-day" value="4" /> Thu</label>
            <label><input type="checkbox" class="biz-day" value="5" /> Fri</label>
            <label><input type="checkbox" class="biz-day" value="6" /> Sat</label>
            <label><input type="checkbox" class="biz-day" value="0" /> Sun</label>
          </div>

          <button id="saveBizHours" class="btn btn-secondary">
            Save Business Hours
          </button>
          <p id="bizSaveStatus" class="status-text"></p>

          <div class="hint">
            Default (if not set): 07:00â€“19:00 Mondayâ€“Saturday.
          </div>
        </section>

        <!-- ADMIN PIN + AUDIT -->
        <section class="console-section">
          <h2>Admin Security</h2>

          <div class="field-group">
            <label class="field">
              <span>Change PIN</span>
              <input id="newPin" type="password" autocomplete="new-password"
                     placeholder="New PIN (min 6 chars)" />
            </label>
            <label class="field">
              <span>Confirm PIN</span>
              <input id="confirmPin" type="password"
                     autocomplete="new-password" />
            </label>
            <button id="savePin" class="btn btn-secondary">
              Update PIN
            </button>
            <p id="pinSaveStatus" class="status-text"></p>
          </div>

          <h3>Audit Log (browser-local)</h3>
          <textarea id="auditLog" rows="10" readonly class="mono"></textarea>
          <button id="clearAudit" class="btn btn-ghost">
            Clear Local Audit Log
          </button>
        </section>
      </div>

      <div class="console-footer">
        <button id="logoutBtn" class="btn btn-outline">Logout</button>
      </div>
    </section>
  </main>

  <!-- FOOTER -->
  <footer class="vb-footer">
    <div class="vb-footer-inner">
      <div class="vb-footer-right">
        <img src="assets/US-Signal-Logo.png" alt="US Signal" class="footer-logo" />
        <span>Created and maintained by <strong>Ahmed Adeyemi, US Signal</strong></span>
      </div>
    </div>
  </footer>
</body>
</html>
