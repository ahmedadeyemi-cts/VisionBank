<!DOCTYPE html>
<html>
<head>
    <title>Contact Center Realtime Dashboard</title>
    <meta charset="utf-8" />
    <style>
        :root {
            --primary: #444f5a;
            --header-bg: #e5e7eb;
            --table-header-bg: #f3f4f6;
            --available: #00aa00;
            --busy: #e53935;
            --break: #e67e22;
            --other: #7f8c8d;
            --bg: #f5f7fa;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            padding: 20px 40px;
            font-family: Arial, sans-serif;
            background: var(--bg);
            color: #111827;
        }

        .logo-bar {
            text-align: center;
            margin-bottom: 10px;
        }

        .logo-bar img {
            max-width: 260px;
        }

        h1 {
            text-align: center;
            margin: 0;
            margin-bottom: 6px;
            font-size: 30px;
            color: #111827;
        }

        .sub-brand {
            text-align: center;
            font-size: 22px;
            font-weight: bold;
            color: #111827;
            margin-bottom: 22px;
        }

        .section {
            margin-bottom: 24px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(15,23,42,0.15);
        }

        .section-header {
            background: var(--header-bg);
            padding: 8px 16px;
            font-weight: bold;
            color: var(--primary);
            display: flex;
            align-items: center;
            font-size: 15px;
        }

        .section-header .toggle {
            margin-right: 8px;
            font-weight: bold;
        }

        .section-body {
            padding: 10px 16px 14px 16px;
        }

        .section-summary {
            font-size: 12px;
            margin-bottom: 8px;
            color: #374151;
        }

        .link-bar {
            font-size: 12px;
            margin-bottom: 8px;
        }

        .link-bar span {
            color: #1f6feb;
            margin-right: 16px;
            cursor: default;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        th, td {
            border: 1px solid #d1d5db;
            padding: 4px 6px;
            text-align: left;
            white-space: nowrap;
        }

        th {
            background: var(--table-header-bg);
            font-weight: bold;
        }

        .group-header {
            background: #e5e7eb;
            text-align: center;
            font-weight: bold;
        }

        tr:nth-child(even) {
            background: #fafafa;
        }

        tr:hover {
            background: #eef2ff;
        }

        .status-available {
            color: var(--available);
            font-weight: bold;
        }

        .status-busy {
            color: var(--busy);
            font-weight: bold;
        }

        .status-break {
            color: var(--break);
            font-weight: bold;
        }

        .status-other {
            color: var(--other);
            font-weight: bold;
        }

        .timestamp {
            font-family: "SF Mono", Menlo, monospace;
        }

        .error {
            color: #d32f2f;
            font-weight: bold;
            font-size: 12px;
        }

        .footer {
            text-align: center;
            margin-top: 26px;
            font-size: 14px;
        }

        .footer img {
            max-width: 120px;
            border-radius: 10px;
            margin-top: 8px;
        }
    </style>
</head>
<body>

<div class="logo-bar">
    <img src="https://www.visionbank.com/assets/images/logo-ef1ce85eaa089c55123f761d44755726.png"
         alt="VisionBank Iowa">
</div>

<h1>VisionBank Contact Center Realtime Dashboard</h1>
<div class="sub-brand">VisionBank</div>

<!-- Daily Queue Statistics -->
<div class="section" id="dailyQueueSection">
    <div class="section-header">
        <span class="toggle">−</span> Daily Queue Statistics
    </div>
    <div class="section-body">
        <div class="table-wrapper">
            <div id="dailyQueueContent"></div>
        </div>
    </div>
</div>

<!-- Current Queue Status -->
<div class="section" id="queueStatusSection">
    <div class="section-header">
        <span class="toggle">−</span> Current Queue Status
    </div>
    <div class="section-body">
        <div class="table-wrapper">
            <div id="queueStatusContent"></div>
        </div>
    </div>
</div>

<!-- Current Agent Status -->
<div class="section" id="agentStatusSection">
    <div class="section-header">
        <span class="toggle">−</span> Current Agent Status
    </div>
    <div class="section-body">
        <div id="agentSummary" class="section-summary"></div>
        <div class="link-bar">
            <span>Log Agent Out</span>
            <span>Log Telagent In</span>
            <span>Switch to Telagent</span>
            <span>Text Message</span>
            <span>Available</span>
            <span>Not Available</span>
        </div>
        <div class="table-wrapper">
            <div id="agentStatusContent"></div>
        </div>
    </div>
</div>

<div class="footer">
    Created and maintained by <b>Ahmed Adeyemi</b>, <b>US Signal</b><br>
    <img src="https://pbs.twimg.com/profile_images/1953824036779069440/y1m7bXKK_400x400.jpg"
         alt="US Signal">
</div>

<script>
    // Proxy base
    const BASE_URL = "https://visionbank-tel1.onrender.com";

    // Helpers

    function formatSeconds(sec) {
        if (sec === null || sec === undefined || isNaN(sec)) return "00:00:00";
        sec = Math.floor(sec);
        const h = String(Math.floor(sec / 3600)).padStart(2, "0");
        const m = String(Math.floor((sec % 3600) / 60)).padStart(2, "0");
        const s = String(sec % 60).padStart(2, "0");
        return `${h}:${m}:${s}`;
    }

    function formatCentral(utcString) {
        if (!utcString) return "";
        const d = new Date(utcString);
        if (isNaN(d)) return "";
        return d.toLocaleString("en-US", { timeZone: "America/Chicago" });
    }

    async function callAPI(endpoint) {
        try {
            const res = await fetch(`${BASE_URL}${endpoint}`);
            if (!res.ok) {
                console.error("API error", endpoint, res.status);
                return null;
            }
            return await res.json();
        } catch (e) {
            console.error("Fetch error", endpoint, e);
            return null;
        }
    }

    // Daily queue stats – structure may vary slightly, so we check common field names
    function renderDailyQueueStats(data) {
        if (!data) return "<div class='error'>Error loading queue statistics</div>";
        const rows = data.QueueStatistics || data.queueStatistics || data;

        if (!rows || !rows.length) {
            return "<div class='section-summary'>No queue statistics available.</div>";
        }

        let html = `
            <table>
                <tr>
                    <th rowspan="2">Queue</th>
                    <th rowspan="2">Qd.</th>
                    <th rowspan="2">Rt.</th>
                    <th rowspan="2">FDQ.</th>
                    <th rowspan="2">Ab.</th>
                    <th rowspan="2">VM.</th>
                    <th rowspan="2">Rt. Rate</th>
                    <th rowspan="2">Ab. Rate</th>
                    <th rowspan="2">Service Level</th>
                    <th colspan="3" class="group-header">Wait Time</th>
                    <th colspan="3" class="group-header">Talk Time</th>
                </tr>
                <tr>
                    <th>Min.</th>
                    <th>Max.</th>
                    <th>Avg.</th>
                    <th>Min.</th>
                    <th>Max.</th>
                    <th>Avg.</th>
                </tr>
        `;

        rows.forEach(q => {
            html += `
                <tr>
                    <td>${q.QueueName || q.queueName || ""}</td>
                    <td>${q.Queued || q.Qd || q.TotalCallsQueued || ""}</td>
                    <td>${q.Routed || q.Rt || ""}</td>
                    <td>${q.FirstDayQueued || q.FDQ || ""}</td>
                    <td>${q.Abandoned || q.Ab || ""}</td>
                    <td>${q.Voicemail || q.VM || ""}</td>
                    <td>${q.RouteRate != null ? q.RouteRate : ""}</td>
                    <td>${q.AbandonRate != null ? q.AbandonRate : ""}</td>
                    <td>${q.ServiceLevel != null ? q.ServiceLevel : ""}</td>
                    <td>${formatSeconds(q.WaitTimeMin)}</td>
                    <td>${formatSeconds(q.WaitTimeMax)}</td>
                    <td>${formatSeconds(q.WaitTimeAvg)}</td>
                    <td>${formatSeconds(q.TalkTimeMin)}</td>
                    <td>${formatSeconds(q.TalkTimeMax)}</td>
                    <td>${formatSeconds(q.TalkTimeAvg)}</td>
                </tr>
            `;
        });

        html += "</table>";
        return html;
    }

    function renderQueueStatus(data) {
        if (!data) return "<div class='error'>Error loading queue status</div>";
        const rows = data.QueueStatus || data.queueStatus || data;

        if (!rows || !rows.length) {
            return "<div class='section-summary'>No active queues.</div>";
        }

        let html = `
            <table>
                <tr>
                    <th>Queue</th>
                    <th>Calls</th>
                    <th>Agents</th>
                    <th>Wait</th>
                </tr>
        `;

        rows.forEach(q => {
            html += `
                <tr>
                    <td>${q.QueueName || q.queueName || ""}</td>
                    <td>${q.Calls != null ? q.Calls : q.CallsWaiting || 0}</td>
                    <td>${q.Agents != null ? q.Agents : q.AgentsLoggedIn || ""}</td>
                    <td>${formatSeconds(q.OldestWaitTimeSeconds || q.OldestWaitSeconds || q.WaitSeconds)}</td>
                </tr>
            `;
        });

        html += "</table>";
        return html;
    }

    function classifyAgentState(a) {
        const s = (a.CallTransferStatusDesc || a.AgentStateDesc || a.Status || "").toLowerCase();
        if (s.includes("available")) return "available";
        if (s.includes("busy on call") || s.includes("on call")) return "oncall";
        if (s.includes("wrap")) return "wrap";
        if (s.includes("break")) return "break";
        return "other";
    }

    function stateCssClass(state) {
        if (state === "available") return "status-available";
        if (state === "oncall") return "status-busy";
        if (state === "break") return "status-break";
        return "status-other";
    }

    function renderAgentStatus(data) {
        if (!data) return "<div class='error'>Error loading agent status</div>";
        const rows = data.AgentStatus || data.agentStatus || data;

        if (!rows || !rows.length) {
            document.getElementById("agentSummary").textContent = "No agents signed on.";
            return "<div></div>";
        }

        // Summary metrics
        let signedOn = rows.length;
        let available = 0, oncall = 0, wrap = 0, brk = 0, other = 0;

        rows.forEach(a => {
            const cls = classifyAgentState(a);
            if (cls === "available") available++;
            else if (cls === "oncall") oncall++;
            else if (cls === "wrap") wrap++;
            else if (cls === "break") brk++;
            else other++;
        });

        document.getElementById("agentSummary").textContent =
            `${signedOn} agents signed on, ${available} available, ${oncall} on call, ` +
            `${wrap} on wrap-up, ${brk} on break, ${other} on other statuses`;

        // Table itself
        let html = `
            <table>
                <tr>
                    <th rowspan="2">Agent</th>
                    <th rowspan="2">Team</th>
                    <th rowspan="2">Phone No.</th>
                    <th rowspan="2">Status</th>
                    <th rowspan="2">Duration</th>
                    <th colspan="4" class="group-header">Incoming calls</th>
                    <th colspan="8" class="group-header">Time Management</th>
                    <th rowspan="2">Start Date</th>
                </tr>
                <tr>
                    <th>An.</th>
                    <th>Miss.</th>
                    <th>Trans.</th>
                    <th>Out. Calls</th>
                    <th>Log. On</th>
                    <th>Not Ready</th>
                    <th>Avail.</th>
                    <th>On Inc. Calls</th>
                    <th>On Out. Calls</th>
                    <th>Wrap-up</th>
                    <th>Break</th>
                    <th>Other</th>
                </tr>
        `;

        rows.forEach(a => {
            const state = classifyAgentState(a);
            const css = stateCssClass(state);
            const statusText = a.CallTransferStatusDesc || a.AgentStateDesc || a.Status || "";

            // Try to pick a reasonable duration field
            const durationSec = a.NormalOnCallInterval ??
                                a.NormalACWInterval ??
                                a.LogonInterval ?? 0;

            const answered = a.TotalCallCount ?? a.TotalCallsReceived ?? "";
            const missed = a.TotalCallsMissed ?? "";
            const trans = a.ThirdPartyTransferCount ?? "";
            const outCalls = a.TotalCallsOut ?? a.DialoutCount ?? "";

            const logOn = a.LogonInterval;
            const notReady = a.TotalSecondsNotSet;
            const avail = a.TotalSecondsAvailable;
            const onInc = a.TotalSecondsOnCall;
            const onOut = a.TotalSecondsDialingOut;
            const wrapup = a.TotalSecondsACW;
            const brk = a.TotalSecondsOnBreak;
            const otherTime = a.TotalSecondsBusy;

            html += `
                <tr>
                    <td>${a.FullName || ""}</td>
                    <td>${a.TeamName || ""}</td>
                    <td>${a.PhoneExt || ""}</td>
                    <td class="${css}">${statusText}</td>
                    <td>${formatSeconds(durationSec)}</td>
                    <td>${answered}</td>
                    <td>${missed}</td>
                    <td>${trans}</td>
                    <td>${outCalls}</td>
                    <td>${formatSeconds(logOn)}</td>
                    <td>${formatSeconds(notReady)}</td>
                    <td>${formatSeconds(avail)}</td>
                    <td>${formatSeconds(onInc)}</td>
                    <td>${formatSeconds(onOut)}</td>
                    <td>${formatSeconds(wrapup)}</td>
                    <td>${formatSeconds(brk)}</td>
                    <td>${formatSeconds(otherTime)}</td>
                    <td class="timestamp">${formatCentral(a.StartDateUtc)}</td>
                </tr>
            `;
        });

        html += "</table>";
        return html;
    }

    async function loadDashboard() {
        const [queueStats, queueStatus, agents] = await Promise.all([
            callAPI("/queue-stats"),
            callAPI("/queues"),
            callAPI("/agents")
        ]);

        document.getElementById("dailyQueueContent").innerHTML = renderDailyQueueStats(queueStats);
        document.getElementById("queueStatusContent").innerHTML = renderQueueStatus(queueStatus);
        document.getElementById("agentStatusContent").innerHTML = renderAgentStatus(agents);
    }

    loadDashboard();
    setInterval(loadDashboard, 5000);
</script>

</body>
</html>
