<!DOCTYPE html>
<html>
<head>
    <title>Contact Center Realtime Dashboard</title>

    <style>
        :root {
            --primary: #1f2933;
            --primary-light: #243447;
            --accent-green: #27ae60;
            --accent-red: #e74c3c;
            --accent-amber: #f39c12;
            --bg: #f5f7fa;
            --card-bg: #ffffff;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg);
            color: #111827;
        }

        /* Header */

        .header-logo {
            text-align: center;
            margin-bottom: 10px;
        }

        .header-logo img {
            max-width: 300px;
        }

        h1 {
            text-align: center;
            margin: 0;
            margin-bottom: 4px;
            font-size: 34px;
            color: var(--primary);
            font-weight: bold;
        }

        .brand-tagline {
            text-align: center;
            font-size: 24px;
            color: var(--primary);
            font-weight: bold;
            margin-bottom: 24px;
        }

        /* Sections */

        .section {
            margin-bottom: 24px;
            background: var(--card-bg);
            border-radius: 10px;
            padding: 0;
            box-shadow: 0 2px 8px rgba(15, 23, 42, 0.12);
            overflow: hidden;
        }

        .section-header {
            background-color: var(--primary);
            color: #ffffff;
            padding: 10px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }

        .section-title {
            font-weight: bold;
            font-size: 18px;
        }

        .section-chevron {
            font-size: 18px;
            margin-left: 8px;
        }

        .section-subtitle {
            font-size: 13px;
            opacity: 0.85;
        }

        .section-body {
            padding: 12px 16px 16px 16px;
        }

        .summary-bar {
            font-size: 13px;
            margin-bottom: 8px;
        }

        .summary-pill {
            display: inline-block;
            padding: 2px 8px;
            margin-right: 6px;
            border-radius: 999px;
            font-size: 12px;
            color: #ffffff;
        }

        .summary-pill.green { background-color: var(--accent-green); }
        .summary-pill.red   { background-color: var(--accent-red); }
        .summary-pill.amber { background-color: var(--accent-amber); }

        /* Tables */

        .table-wrapper {
            width: 100%;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            white-space: nowrap;
        }

        th, td {
            border: 1px solid #e5e7eb;
            padding: 6px 8px;
            text-align: left;
        }

        th {
            background: #111827;
            color: #ffffff;
            font-weight: 600;
        }

        tr:nth-child(even) {
            background-color: #f9fafb;
        }

        tr:hover {
            background-color: #eef2ff;
        }

        .state-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
            color: #ffffff;
        }

        .state-ready-badge   { background-color: var(--accent-green); }
        .state-notready-badge{ background-color: var(--accent-amber); }
        .state-busy-badge    { background-color: var(--accent-red); }
        .state-other-badge   { background-color: #6b7280; }

        .subheader-row th {
            background: #4b5563;
            font-size: 12px;
        }

        .group-header {
            text-align: center;
            font-weight: 600;
            background: #111827;
        }

        .timestamp {
            font-family: "SF Mono", Menlo, monospace;
            font-size: 12px;
        }

        .error {
            color: var(--accent-red);
            font-weight: bold;
            padding: 4px 0;
        }

        /* Footer */

        .footer {
            text-align: center;
            margin-top: 32px;
            opacity: 0.95;
        }

        .footer-text {
            font-size: 18px;
            color: var(--primary);
            font-weight: bold;
            margin-bottom: 10px;
        }

        .footer img {
            max-width: 150px;
            border-radius: 10px;
        }

        /* Collapsible */

        .collapsible-content {
            display: block;
        }

        .section.collapsed .collapsible-content {
            display: none;
        }

        .section.collapsed .section-chevron {
            transform: rotate(-90deg);
        }

        .last-updated {
            font-size: 11px;
            color: #6b7280;
            margin-top: 4px;
        }
    </style>
</head>

<body>

<div class="header-logo">
    <img src="https://www.visionbank.com/assets/images/logo-ef1ce85eaa089c55123f761d44755726.png"
         alt="VisionBank Iowa">
</div>

<h1>VisionBank Contact Center Realtime Dashboard</h1>
<div class="brand-tagline">VisionBank</div>

<div id="agentsSection" class="section"></div>
<div id="queuesSection" class="section"></div>
<div id="queueStatsSection" class="section"></div>
<div id="ivrStatsSection" class="section"></div>
<div id="historicalSection" class="section"></div>

<div class="footer">
    <div class="footer-text">
        Created and maintained by <b>Ahmed Adeyemi</b>, <b>US Signal</b>
    </div>
    <img src="https://pbs.twimg.com/profile_images/1953824036779069440/y1m7bXKK_400x400.jpg"
         alt="US Signal">
</div>

<script>
    // Replace this with your Render proxy URL after deployment
    const BASE_URL = "YOUR_PROXY_URL_HERE";

    function createSectionHtml(title, id, subtitle = "") {
        return `
            <div class="section-header" onclick="toggleSection('${id}')">
                <div>
                    <div class="section-title">${title}</div>
                    ${subtitle ? `<div class="section-subtitle">${subtitle}</div>` : ""}
                </div>
                <div class="section-chevron">â–¾</div>
            </div>
            <div class="section-body">
                <div id="${id}" class="collapsible-content"></div>
            </div>
        `;
    }

    function toggleSection(contentId) {
        const sectionBody = document.getElementById(contentId).closest(".section");
        sectionBody.classList.toggle("collapsed");
    }

    async function callAPI(endpoint) {
        try {
            const res = await fetch(`${BASE_URL}${endpoint}`);
            if (!res.ok) {
                console.error("API error", endpoint, res.status);
                return null;
            }
            return await res.json();
        } catch (err) {
            console.error("Fetch error", endpoint, err);
            return null;
        }
    }

    function computeAgentSummary(rows) {
        let total = rows.length;
        let ready = 0, busy = 0, notReady = 0, other = 0;

        rows.forEach(a => {
            const s = (a.AgentStateDesc || a.state || "").toLowerCase();
            if (s.includes("ready") && !s.includes("not")) ready++;
            else if (s.includes("busy")) busy++;
            else if (s.includes("not ready") || s.includes("notset") || s.includes("not set")) notReady++;
            else other++;
        });

        return { total, ready, busy, notReady, other };
    }

    function renderAgents(data) {
        if (!data) return "<div class='error'>Error loading agent status</div>";

        const rows = data.AgentStatus || data;
        const summary = computeAgentSummary(rows);

        let html = `
            <div class="summary-bar">
                <span>${summary.total} agents tracked.</span>
                <span class="summary-pill green">${summary.ready} ready</span>
                <span class="summary-pill red">${summary.busy} busy</span>
                <span class="summary-pill amber">${summary.notReady} not ready</span>
                ${summary.other ? `<span class="summary-pill">${summary.other} other</span>` : ""}
            </div>
            <div class="table-wrapper">
            <table>
                <tr>
                    <th rowspan="2">Agent</th>
                    <th rowspan="2">Phone Ext</th>
                    <th rowspan="2">Status</th>
                    <th rowspan="2">Last Access</th>
                    <th rowspan="2">Logon Interval (sec)</th>
                </tr>
        `;

        rows.forEach(a => {
            const state = a.AgentStateDesc || "Unknown";
            const stateLower = state.toLowerCase();
            let css = "state-other-badge";
            if (stateLower.includes("ready") && !stateLower.includes("not")) css = "state-ready-badge";
            else if (stateLower.includes("not ready") || stateLower.includes("not set")) css = "state-notready-badge";
            else if (stateLower.includes("busy")) css = "state-busy-badge";

            html += `
                <tr>
                    <td>${a.FullName || ""}</td>
                    <td>${a.PhoneExt || ""}</td>
                    <td><span class="state-badge ${css}">${state}</span></td>
                    <td class="timestamp">${a.LastAccessDateUtc || ""}</td>
                    <td>${a.LogonInterval != null ? a.LogonInterval : ""}</td>
                </tr>
            `;
        });

        html += "</table></div>";
        html += `<div class="last-updated">Last updated: ${new Date().toLocaleTimeString()}</div>`;
        return html;
    }

    function renderQueues(data) {
        if (!data) return "<div class='error'>Error loading queue status</div>";

        const rows = data.QueueStatus || data;

        let html = `
            <div class="table-wrapper">
            <table>
                <tr>
                    <th>Queue Name</th>
                    <th>Status</th>
                    <th>Waiting</th>
                    <th>Oldest Wait</th>
                </tr>
        `;

        rows.forEach(q => {
            html += `
                <tr>
                    <td>${q.QueueName || q.queueName || ""}</td>
                    <td>${q.Status || q.status || ""}</td>
                    <td>${q.WaitingCount != null ? q.WaitingCount : q.waitingCount || 0}</td>
                    <td>${q.OldestWaitTime || q.oldestWaitTime || ""}</td>
                </tr>
            `;
        });

        html += "</table></div>";
        return html;
    }

    function renderQueueStats(data) {
        if (!data) return "<div class='error'>Error loading queue statistics</div>";

        const rows = data.QueueStatistics || data;

        let html = `
            <div class="table-wrapper">
            <table>
                <tr>
                    <th>Queue</th>
                    <th>Handled</th>
                    <th>Abandoned</th>
                    <th>Service Level</th>
                </tr>
        `;

        rows.forEach(q => {
            html += `
                <tr>
                    <td>${q.QueueName || ""}</td>
                    <td>${q.Handled != null ? q.Handled : ""}</td>
                    <td>${q.Abandoned != null ? q.Abandoned : ""}</td>
                    <td>${q.ServiceLevel != null ? q.ServiceLevel : ""}</td>
                </tr>
            `;
        });

        html += "</table></div>";
        return html;
    }

    function renderIVRStats(data) {
        if (!data) return "<div class='error'>Error loading IVR statistics</div>";

        const rows = data.IvrStatistics || data;

        let html = `
            <div class="table-wrapper">
            <table>
                <tr>
                    <th>IVR Name</th>
                    <th>Entries</th>
                    <th>Exits</th>
                </tr>
        `;

        rows.forEach(i => {
            html += `
                <tr>
                    <td>${i.IvrName || ""}</td>
                    <td>${i.EntryCount != null ? i.EntryCount : ""}</td>
                    <td>${i.ExitCount != null ? i.ExitCount : ""}</td>
                </tr>
            `;
        });

        html += "</table></div>";
        return html;
    }

    function renderHistorical(data) {
        if (!data) return "<div class='error'>Error loading agent sessions</div>";

        const rows = data.AgentSessions || data;

        let html = `
            <div class="table-wrapper">
            <table>
                <tr>
                    <th>Agent</th>
                    <th>Login Time (UTC)</th>
                    <th>Logout Time (UTC)</th>
                </tr>
        `;

        rows.forEach(h => {
            html += `
                <tr>
                    <td>${h.AgentName || h.AgentId || ""}</td>
                    <td class="timestamp">${h.LoginTimeUtc || ""}</td>
                    <td class="timestamp">${h.LogoutTimeUtc || ""}</td>
                </tr>
            `;
        });

        html += "</table></div>";
        return html;
    }

    async function loadDashboard() {
        const today = new Date().toISOString().split("T")[0];

        document.getElementById("agentsSection").innerHTML =
            createSectionHtml("Agent Status", "agentContent", "Live agent presence and status by extension");

        document.getElementById("queuesSection").innerHTML =
            createSectionHtml("Queue Status", "queueContent", "Current queue depth and wait times");

        document.getElementById("queueStatsSection").innerHTML =
            createSectionHtml("Queue Statistics", "queueStatsContent", "Handled, abandoned and service level");

        document.getElementById("ivrStatsSection").innerHTML =
            createSectionHtml("IVR Statistics", "ivrContent", "IVR entry and exit activity");

        document.getElementById("historicalSection").innerHTML =
            createSectionHtml("Agent Sessions Today", "historyContent", "Logon and logout times for today");

        const [agents, queues, queueStats, ivrStats, historical] = await Promise.all([
            callAPI("/agents"),
            callAPI("/queues"),
            callAPI("/queue-stats"),
            callAPI("/ivr-stats"),
            callAPI(`/agent-sessions/${today}`)
        ]);

        document.getElementById("agentContent").innerHTML = renderAgents(agents);
        document.getElementById("queueContent").innerHTML = renderQueues(queues);
        document.getElementById("queueStatsContent").innerHTML = renderQueueStats(queueStats);
        document.getElementById("ivrContent").innerHTML = renderIVRStats(ivrStats);
        document.getElementById("historyContent").innerHTML = renderHistorical(historical);
    }

    loadDashboard();
    setInterval(loadDashboard, 5000);
</script>

</body>
</html>
