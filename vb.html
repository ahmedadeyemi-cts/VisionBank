<!DOCTYPE html>
<html>
<head>
    <title>Contact Center Realtime Dashboard</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f7fa;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 34px;
            color: #2c3e50;
            font-weight: bold;
        }

        .brand-tagline {
            text-align: center;
            font-size: 34px;
            color: #2c3e50;
            font-weight: bold;
            margin-top: -5px;
            margin-bottom: 30px;
        }

        h2 {
            background-color: #2c3e50;
            color: white;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        .section {
            margin-bottom: 25px;
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
        }

        th {
            background: #34495e;
            color: white;
        }

        .state-ready {
            background-color: #2ecc71;
            color: white;
        }

        .state-notready {
            background-color: #e74c3c;
            color: white;
        }

        .state-busy {
            background-color: #f39c12;
            color: white;
        }

        .collapsible-content {
            display: none;
            padding-top: 10px;
        }

        .footer {
            text-align: center;
            margin-top: 40px;
            opacity: 0.9;
        }

        .footer-text {
            font-size: 22px;
            color: #2c3e50;
            font-weight: bold;
            margin-bottom: 10px;
        }
    </style>
</head>

<body>

<!-- VisionBank Logo -->
<div style="text-align:center; margin-bottom:10px;">
    <img src="https://www.visionbank.com/assets/images/logo-ef1ce85eaa089c55123f761d44755726.png"
         alt="VisionBank Iowa"
         style="max-width:300px; margin-bottom:10px;">
</div>

<h1>VisionBank Contact Center Realtime Dashboard</h1>
<div class="brand-tagline"><b>VisionBank</b></div>

<div id="agentsSection" class="section"></div>
<div id="queuesSection" class="section"></div>
<div id="queueStatsSection" class="section"></div>
<div id="ivrStatsSection" class="section"></div>
<div id="historicalSection" class="section"></div>

<!-- Footer -->
<div class="footer">
    <div class="footer-text">
        Created and maintained by <b>Ahmed Adeyemi</b>, <b>US Signal</b>
    </div>

    <img src="https://pbs.twimg.com/profile_images/1953824036779069440/y1m7bXKK_400x400.jpg"
         alt="US Signal"
         style="max-width:150px; border-radius: 10px;">
</div>

<script>
    // ðŸ”¥ IMPORTANT: Replace this with your Render.com proxy URL
    const BASE_URL = "YOUR_PROXY_URL_HERE";

    function createCollapsible(title, id) {
        return `
            <h2 onclick="toggle('${id}')">${title}</h2>
            <div id="${id}" class="collapsible-content"></div>
        `;
    }

    function toggle(id) {
        const elem = document.getElementById(id);
        elem.style.display = elem.style.display === "none" ? "block" : "none";
    }

    async function callAPI(endpoint) {
        try {
            const res = await fetch(`${BASE_URL}${endpoint}`);
            if (!res.ok) return null;
            return await res.json();
        } catch (err) {
            console.error("Dashboard Error:", err);
            return null;
        }
    }

    function renderAgents(data) {
        if (!data) return "<div class='error'>Error loading agent status</div>";

        let rows = data.AgentStatus || data;

        let table = `
            <table>
            <tr>
                <th>Full Name</th>
                <th>Extension</th>
                <th>State</th>
                <th>Last Access</th>
                <th>Login Interval</th>
            </tr>
        `;

        rows.forEach(a => {
            let css = a.AgentStateDesc === "Ready" ? "state-ready"
                   : a.AgentStateDesc === "Not Ready" ? "state-notready"
                   : "state-busy";

            table += `
                <tr>
                    <td>${a.FullName}</td>
                    <td>${a.PhoneExt}</td>
                    <td class="${css}">${a.AgentStateDesc}</td>
                    <td>${a.LastAccessDateUtc}</td>
                    <td>${a.LogonInterval}</td>
                </tr>
            `;
        });

        return table + "</table>";
    }

    function renderQueues(data) {
        if (!data) return "<div class='error'>Error loading queues</div>";

        let rows = data.QueueStatus || data;

        let table = `
            <table>
                <tr>
                    <th>Queue Name</th>
                    <th>Waiting</th>
                    <th>Oldest Wait</th>
                </tr>
        `;

        rows.forEach(q => {
            table += `
                <tr>
                    <td>${q.QueueName}</td>
                    <td>${q.WaitingCount}</td>
                    <td>${q.OldestWaitTime}</td>
                </tr>
            `;
        });

        return table + "</table>";
    }

    function renderQueueStats(data) {
        if (!data) return "<div class='error'>Error loading queue statistics</div>";

        let rows = data.QueueStatistics || data;

        let table = `
            <table>
                <tr>
                    <th>Queue</th>
                    <th>Handled</th>
                    <th>Abandoned</th>
                    <th>Service Level</th>
                </tr>
        `;
        rows.forEach(q => {
            table += `
                <tr>
                    <td>${q.QueueName}</td>
                    <td>${q.Handled}</td>
                    <td>${q.Abandoned}</td>
                    <td>${q.ServiceLevel}</td>
                </tr>
            `;
        });

        return table + "</table>";
    }

    function renderIVRStats(data) {
        if (!data) return "<div class='error'>Error loading IVR statistics</div>";

        let rows = data.IvrStatistics || data;

        let table = `
            <table>
                <tr>
                    <th>IVR Name</th>
                    <th>Entries</th>
                    <th>Exits</th>
                </tr>
        `;
        rows.forEach(i => {
            table += `
                <tr>
                    <td>${i.IvrName}</td>
                    <td>${i.EntryCount}</td>
                    <td>${i.ExitCount}</td>
                </tr>
            `;
        });

        return table + "</table>";
    }

    function renderHistorical(data) {
        if (!data) return "<div class='error'>Error loading agent sessions</div>";

        let rows = data.AgentSessions || data;

        let table = `
            <table>
                <tr>
                    <th>Agent</th>
                    <th>Login Time</th>
                    <th>Logout Time</th>
                </tr>
        `;
        rows.forEach(h => {
            table += `
                <tr>
                    <td>${h.AgentName}</td>
                    <td>${h.LoginTimeUtc}</td>
                    <td>${h.LogoutTimeUtc}</td>
                </tr>
            `;
        });

        return table + "</table>";
    }

    async function loadDashboard() {
        const today = new Date().toISOString().split("T")[0];

        document.getElementById("agentsSection").innerHTML = createCollapsible("Agent Status", "agentContent");
        document.getElementById("queuesSection").innerHTML = createCollapsible("Queue Status", "queueContent");
        document.getElementById("queueStatsSection").innerHTML = createCollapsible("Queue Statistics", "queueStatsContent");
        document.getElementById("ivrStatsSection").innerHTML = createCollapsible("IVR Statistics", "ivrContent");
        document.getElementById("historicalSection").innerHTML = createCollapsible("Agent Sessions Today", "historyContent");

        const [agents, queues, qStats, ivrs, history] = await Promise.all([
            callAPI("/agents"),
            callAPI("/queues"),
            callAPI("/queue-stats"),
            callAPI("/ivr-stats"),
            callAPI(`/agent-sessions/${today}`)
        ]);

        document.getElementById("agentContent").innerHTML = renderAgents(agents);
        document.getElementById("queueContent").innerHTML = renderQueues(queues);
        document.getElementById("queueStatsContent").innerHTML = renderQueueStats(qStats);
        document.getElementById("ivrContent").innerHTML = renderIVRStats(ivrs);
        document.getElementById("historyContent").innerHTML = renderHistorical(history);
    }

    loadDashboard();
    setInterval(loadDashboard, 5000);
</script>

</body>
</html>
